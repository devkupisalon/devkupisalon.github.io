<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Test Telegram WebApps</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      color: var(--tg-theme-text-color);
      background: var(--tg-theme-bg-color);
      padding-top: 40px;
    }
    
    .container {
      width: fit-content;
      display: flex;
      flex-direction: column;
      text-align: center;
      height: 350px;
      margin: 0 auto;
      padding: 10px 20px;
      border-radius: 20px;
      background-color: var(--tg-theme-header-bg-color);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    p {
      margin-bottom: 20px;
      color: var(--tg-theme-hint-color);
    }

    h3 {
      margin-bottom: 30px;
      color: var(--tg-theme-section-header-text-color);
    }
    
    .button,
    .fill-tg {
      height: 40px;
      font-weight: bold;
      font-size: 16px;
      width: 100%;
      margin: 0 auto;
      padding: 10px 20px;
      color: var(--tg-theme-button-text-color);
      background: var(--tg-theme-button-color);
      border-radius: 20px;
      border: none;
    }
    
    @media only screen and (min-width: 768px) {
      .container {
        max-width: 400px;
      }
    }
    
    input:invalid {
      border-color: red;
    }
    
    input:valid {
      border: 2px solid #007bff;
    }
    
    .input-form {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
    }
    
   .input-label {
    text-align: center;
    width: calc(23% - 10px);
    font-weight: bold;
    margin-right: 10px;
    margin-bottom: 20px;
    background-color: var(--tg-theme-button-color);
    color: var(--tg-theme-button-text-color);
    padding: 10px 20px;
    border-radius: 20px;
}

input[type="text"],
input[type="tel"] {
    width: calc(55% - 10px);
    color: var(--tg-theme-text-color);
    padding: 10px 20px;
    border-radius: 20px;
    margin-bottom: 20px;
    background-color: var(--tg-theme-bg-color);
}
    
    button:hover {
      transform: scale(1.05);
    }
  </style>

</head>

<body>
  <iframe id="myFrame" style="display: none; width: 380px; height: 700px; border: none;" "></iframe>

     <div class="container ">
        <form id="partner-form ">
             <h3 id="main-heading ">Заполните пожалуйста номер ФИО и номер телефона</h3>
            <div class="input-form ">
                <div class="input-label " id="manager-name-label ">ФИО</div>
                <input class="input " type="text " id="manager-name " placeholder="Name " required
                    oninput="validateName(event.target) ">
                <div class="input-label " id="manager-phone-label ">Телефон</div>
                <input class="input " type="tel " id="manager-phone " placeholder="+79999999999 " required
                    oninput="formatPhoneNumber(this) ">
                    <p id="fill-text ">Или Вы можете заполнить ФИО и номер телефона из телеграма (проверьте заполнены ли у вас имя и фамилия в тг)</p>
                <button class="fill-tg " id=" 'autofill-tg">Поделиться контактом</button>
            </div>
        </form>
    </div>

   <script>
         const tg = window.Telegram.WebApp;
   tg.expand();
   tg.ready();
   tg.enableClosingConfirmation();
   tg.BackButton.show();
   tg.setBottomBarColor("bottom_bar_bg_color");

      const {
  bg_color,
  text_color,
  hint_color,
  button_color,
  button_text_color,
  secondary_bg_color,
         header_bg_color
} = Telegram.WebApp.themeParams;

const fields = {
  name: '#manager-name ',
  phone: '#manager-phone ',
};

const setCheckmark = s => {
  s.style.pointerEvents = "none";
  s.style.opacity = "0.5";
};

const fill_tg = document.querySelector('.fill-tg ');
const n = document.getElementById('manager-name ');
const ph = document.getElementById('manager-phone ');

tg.BackButton.show();
tg.setBottomBarColor("bottom_bar_bg_color");

fill_tg.addEventListener('click ', async () => {
  await tg.requestContact(async (shared, callback) => {
    if (shared && callback) {
      console.log(callback);
        const contact = callback.responseUnsafe.contact;
        const name = `${contact.first_name} ${contact.last_name}`;
        const phone = contact.phone_number;
        n.value = `${contact.first_name} ${contact.last_name}`;
        ph.value = phone;
        setCheckmark(fill_tg);
    }
  });
});

function formatPhoneNumber(input) {

  if (!input.value.startsWith('+ ') && input.value.match(/^\d/)) {
    input.value = '+ ' + input.value;
  }
  if (input.value === '+ ') {
    input.value = ' ';
  }
  input.value = input.value.replace(/[^+d (\d)-]/, ' ');
  if (input.value.startsWith('+ ')) {
    input.value = input.value.substring(0, 4) + input.value.substring(4).replace(/[^0-9]/g, ' ').slice(0, 13);
  } else {
    input.value = input.value.replace(/[^0-9]/g, ' ').slice(0, 10);
  }
}

function validateName(input) {
  let value = input.value;
  let pattern = /^[A-Za-zА-ЯЁа-яё]+([- ][A-Za-zА-ЯЁа-яё]+)*$/;
  if (!value.match(pattern)) {
    input.setCustomValidity("Имя должно содержать только буквы и может включать пробелы или дефисы.");
  }

  value = value.replaceAll(/\d+/g, ' ');
  input.value = value;
  input.setCustomValidity("");
}

      function getValues() {

  const data = Object.fromEntries(
    Object.entries(fields).map(([key, selector]) => [key, document.querySelector(selector).value])
  );

 
  return { manager_name, phone };
}

  tg.MainButton.show();
  tg.MainButton.setParams({ has_shine_effect: true, text: 'Продолжить ', });

  tg.onEvent('mainButtonClicked ', async (event) => {
    tg.MainButton.showProgress(true);

    const {  name, phone } = getValues();
    
    if (  manager_name && phone ) {

      try {

      const containerToHide = document.querySelector('.container ');
      containerToHide.style.display = "none";

        const iframe = document.getElementById("myFrame");
        const url = `https://script.google.com/a/macros/kupisalon.ru/s/AKfycbxagqE63ravHoT9PK-hd1EOe06tWa7AyBbUhbODdC3cuuuJ_oSELy6LFLacB82NWcCr/exec?phone=${phone}&name=${name}&bg_color=${encodeURIComponent(bg_color)}&text_color=${encodeURIComponent(text_color)}&hint_color=${encodeURIComponent(hint_color)}&button_color=${encodeURIComponent(button_color)}&button_text_color=${encodeURIComponent(button_text_color)}&secondary_bg_color=${encodeURIComponent(secondary_bg_color)}&header_bg_color=${encodeURIComponent(header_bg_color)}`;
         iframe.src = url;

       console.log(url);
       // window.location.href = url;
       
      iframe.style.display = "block";
      } catch (error) {
        tg.showPopup({ title: 'Error ', message: error });
        tg.MainButton.hideProgress();
      }
    } else {
      tg.showPopup({ message: 'Вначале заполните все данные ' });
      tg.MainButton.hideProgress();
    }
  });
      
   </script>
</body>
</html>
